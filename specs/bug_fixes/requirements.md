# 需求文档 - 任务调度与播放稳定性修复

## 概述
修复定时音乐播放器在实际使用中发现的两个关键 bug：跨天任务停止播放、多任务场景下软件卡死。这两个问题严重影响用户体验和应用的核心功能可用性。

## 用户角色
- **普通用户**：使用定时播放功能，设置跨天时间段或多个播放任务

## 功能需求

### FR-1: 跨天任务持续播放
**用户故事：** 作为普通用户，我想要跨天时间段的任务（如 22:00-02:00）在凌晨后继续播放，以便实现完整的定时播放需求

**问题描述：**
- 当任务时间跨天时（开始时间 > 结束时间，如 22:00-02:00）
- 到了 00:00 后，任务停止播放
- 原因：系统检查"今天"是否在重复日中，但跨天任务应该检查"昨天"

**验收标准：**
1. When 用户设置跨天任务（如周一 22:00 - 02:00）且当前时间为周二 01:00, the system shall 继续播放该任务（因为任务从周一开始）
2. When 跨天任务的结束时间到达（如 02:00）, the system shall 正常停止播放
3. When 用户设置非跨天任务（如 08:00-12:00）, the system shall 按原有逻辑正常工作
4. When 跨天任务跨越午夜时, the system shall 无缝继续播放，不出现中断

### FR-2: 多任务稳定播放
**用户故事：** 作为普通用户，我想要设置多个播放任务时软件运行稳定，以便同时管理多个时间段的音频播放

**问题描述：**
- 存在多个任务时，软件可能卡死
- 多个时间段的音频无法正常播放
- 原因：线程安全问题、资源泄漏、无限递归风险

**验收标准：**
1. When 用户创建 10 个以上任务, the system shall 正常运行不卡死
2. When 多个任务同时触发播放, the system shall 正确管理所有任务的播放状态
3. When 任务播放出现异常, the system shall 优雅降级，不影响其他任务
4. While 应用长时间运行（24小时以上）, the system shall 保持稳定，无内存泄漏或线程泄漏

## 非功能需求

### NFR-1: 性能要求
- 任务调度响应时间：< 1 秒
- 内存占用：长时间运行后内存增长 < 10%
- 线程数量：控制在合理范围内（< 20 个活跃线程）

### NFR-2: 稳定性要求
- 应用连续运行 7 天无崩溃
- 跨天任务 100% 正确执行

## 边界条件和异常处理

### 跨天场景
| 场景 | 处理方式 |
|------|----------|
| 周日 23:00 - 周一 01:00 | 检查周日是否在重复日中 |
| 每天 22:00 - 02:00 | 任何一天都应正常跨天播放 |
| 仅周一 22:00 - 02:00，当前周二 01:00 | 继续播放（任务从周一开始） |
| 仅周一 22:00 - 02:00，当前周二 03:00 | 停止播放（已过结束时间） |

### 多任务场景
| 场景 | 处理方式 |
|------|----------|
| 两个任务时间重叠 | 同时播放两个任务 |
| 任务 A 播放中，任务 B 开始 | 任务 B 正常开始，不影响任务 A |
| 所有音频文件都无法播放 | 记录错误日志，停止该任务，不影响其他任务 |
| 线程池满 | 排队等待，不创建无限线程 |

## 技术约束
- 需要保持向后兼容，不改变用户数据结构
- 修复应尽量小范围，避免引入新问题
