# 实施计划 - Bug修复（跨天任务 + 多任务稳定性）

## 实施概览

**预计总工时**：4-6 小时  
**关键里程碑**：
1. 跨天任务逻辑修复
2. 多任务稳定性修复
3. 集成测试验证

---

## 任务列表

### 1. 跨天任务判断逻辑修复

- [ ] **1.1 修改 TaskSchedulerService - 添加跨天判断方法**
  - 添加 `isCrossDay(startTime, endTime)` 方法判断是否跨天
  - 添加 `shouldTaskBeActiveNow(task)` 方法，正确处理跨天场景
  - 当前时间在 00:00-结束时间 之间时，检查"昨天"是否在重复日
  - _需求：FR-1 验收标准 1, 2, 3_

- [ ] **1.2 修改 AlarmReceiver - 使用新的跨天判断逻辑**
  - 在 `handleTaskStart()` 中使用 `shouldTaskBeActiveNow()` 替代原有判断
  - 确保跨天任务在午夜后仍能正确触发
  - _需求：FR-1 验收标准 1, 2_

- [ ] **1.3 修改 TaskCheckWorker - 使用新的跨天判断逻辑**
  - 在定期检查逻辑中使用 `shouldTaskBeActiveNow()` 替代原有判断
  - 确保跨天任务在定期检查时不会被错误停止
  - _需求：FR-1 验收标准 1, 3_

### 2. 多任务稳定性修复

- [ ] **2.1 修改 AudioPlaybackService - 使用 ConcurrentHashMap**
  - 将 `taskPlayers` 从 `HashMap` 改为 `ConcurrentHashMap`
  - 确保所有对 `taskPlayers` 的操作都是线程安全的
  - _需求：FR-2 验收标准 1, 2_

- [ ] **2.2 修改 TaskSchedulerService - 单例模式 + 线程池优化**
  - 将 `TaskSchedulerService` 改为单例模式
  - 将 `newCachedThreadPool()` 改为 `newFixedThreadPool(4)`
  - 添加 `shutdown()` 方法用于资源释放
  - _需求：FR-2 验收标准 2, 3_

- [ ] **2.3 修改 TaskPlayer - 递归深度限制**
  - 在 `playCurrentTrack()` 方法中添加递归深度计数器
  - 限制最大递归深度为 10 次
  - 超过限制时记录错误日志并停止
  - _需求：FR-2 验收标准 4_

### 3. 测试验证

- [ ] **3.1 编译验证**
  - 确保所有修改编译通过
  - 检查无 lint 错误
  - _需求：所有 FR 验收标准_

- [ ] **3.2 打包测试版本**
  - 生成 debug APK
  - 准备测试场景清单
  - _需求：所有 FR 验收标准_

---

## 测试场景清单

### 跨天任务测试
1. 设置 22:00-02:00 的任务，验证午夜后继续播放
2. 设置周日 23:00 - 周一 01:00 的任务，验证跨周正确
3. 设置仅周一的任务 23:00-01:00，验证周二 00:30 时仍在播放

### 多任务测试
1. 同时设置 10+ 个任务，验证不卡死
2. 多个任务时间重叠，验证都能正常播放
3. 长时间运行（1小时+），验证内存稳定

---

## 依赖关系

```
1.1 ──┬──> 1.2
      └──> 1.3

2.1 (独立)
2.2 (独立)
2.3 (独立)

3.1 ──> 3.2 (依赖所有修改完成)
```

---

## 回滚方案

如果修复引入新问题：
1. 所有修改都在独立方法中，可单独回滚
2. 保留原有逻辑的注释，便于对比
3. 使用 git 分支管理，可快速回退
