# 需求文档 - 蓝牙连接保持功能

## 概述
实现蓝牙连接保持和自动重连功能，确保在后台播放音乐时蓝牙连接稳定，提升用户体验。

## 用户角色
- **普通用户**：使用蓝牙音箱/耳机播放定时音乐的用户

## 功能需求

### FR-1: 保持蓝牙活跃
**用户故事：** 作为用户，我想要在没有音乐播放时保持蓝牙连接活跃，以便下次播放时无需重新连接

**验收标准：**
1. When 用户开启"保持蓝牙活跃"设置且当前已连接蓝牙设备, the system shall 在后台播放静音音频保持蓝牙音频通道活跃
2. When 用户关闭"保持蓝牙活跃"设置, the system shall 停止播放静音音频
3. While "保持蓝牙活跃"开启且有任务正在播放音乐, the system shall 暂停静音音频播放，避免干扰
4. When 任务音乐播放结束且"保持蓝牙活跃"开启, the system shall 自动恢复静音音频播放

### FR-2: 蓝牙自动重连
**用户故事：** 作为用户，我想要蓝牙断开后自动重新连接，以便不需要手动操作

**验收标准：**
1. When 检测到蓝牙设备断开且"蓝牙自动重连"开启, the system shall 记录断开的蓝牙设备信息
2. When 蓝牙设备断开后, the system shall 尝试主动重连之前连接的蓝牙设备（尽力而为，不保证所有设备有效）
3. When 蓝牙设备重新可用（手动重连或自动重连成功）, the system shall 自动将音频路由恢复到蓝牙设备
4. If 重连尝试失败, then the system shall 在设备重新进入范围时继续监听并尝试恢复

### FR-3: 蓝牙断开用户提示
**用户故事：** 作为用户，我想要在蓝牙断开时收到通知，以便了解当前播放状态

**验收标准：**
1. When 蓝牙设备断开连接, the system shall 发送通知提示用户"蓝牙设备已断开"
2. When 蓝牙设备重新连接成功, the system shall 发送通知提示用户"蓝牙设备已连接"
3. If 正在播放音乐时蓝牙断开, then the system shall 在通知中说明音频已切换到手机扬声器

### FR-4: 全局设置
**用户故事：** 作为用户，我想要在设置中控制蓝牙相关功能的开关

**验收标准：**
1. When 用户进入设置页面, the system shall 显示"保持蓝牙活跃"开关，默认开启
2. When 用户进入设置页面, the system shall 显示"蓝牙自动重连"开关，默认开启
3. When 用户修改设置, the system shall 立即保存并生效
4. When 应用重启, the system shall 恢复用户之前的设置状态

## 非功能需求

### NFR-1: 性能要求
- 静音音频播放不应明显增加电量消耗
- 蓝牙状态检测响应时间 < 1秒

### NFR-2: 兼容性要求
- 支持 Android 8.0 (API 26) 及以上版本
- 支持 Android 12+ 的蓝牙权限要求 (`BLUETOOTH_CONNECT`)

### NFR-3: 可靠性要求
- 静音音频播放应在前台服务中运行，避免被系统杀死
- 蓝牙重连失败不应影响正常音乐播放功能

## 边界条件和异常处理
- **无蓝牙设备连接**：不播放静音音频，不执行重连逻辑
- **蓝牙权限被拒绝**：提示用户授权，功能降级但不崩溃
- **多个蓝牙设备**：优先重连最后使用的音频设备
- **飞行模式**：暂停蓝牙相关功能，飞行模式关闭后恢复
