# 需求文档 - 多任务并发播放限制

## 概述

当前系统已支持多任务同时播放（混音输出），但没有最大并发数限制。本需求增加最大同步播放数限制（10个），当达到上限时拒绝新任务启动，等待有空位后再启动。

## 用户角色

- **普通用户**：创建和管理定时播放任务

## 现状分析

| 项目 | 当前状态 |
|-----|---------|
| 多任务播放 | ✅ 已支持（每任务独立 MediaPlayer） |
| 混音输出 | ✅ 已支持（系统级混音） |
| 同文件播放 | ✅ 已支持（允许多任务播放同一文件） |
| 并发数限制 | ❌ 未实现 |

## 功能需求

### FR-1: 最大并发播放数限制

**用户故事：** 作为系统，我需要限制同时播放的任务数量，以便保证系统资源稳定和音频播放质量。

**验收标准：**

1. When 当前播放任务数 < 10，且有新任务需要启动播放时，the system shall 正常启动该任务的播放
2. When 当前播放任务数 = 10，且有新任务需要启动播放时，the system shall 拒绝启动该任务，并记录日志说明原因
3. When 任务被拒绝启动后，有其他任务停止播放（空位释放）时，the system shall 允许后续到达的任务正常启动
4. While 系统运行期间，the system shall 实时追踪当前正在播放的任务数量

### FR-2: 被拒绝任务的状态处理

**用户故事：** 作为系统，我需要正确处理被拒绝启动的任务状态，以便任务可以在下一个调度周期重试。

**验收标准：**

1. When 一次性任务因并发限制被拒绝时，the system shall 保持任务状态为 SCHEDULED，并在5分钟后重试启动
2. When 重复任务因并发限制被拒绝时，the system shall 保持任务状态为 SCHEDULED，并在5分钟后重试启动
3. If 重试时仍然达到并发上限，then the system shall 继续等待并重试，直到成功启动或任务结束时间到达
4. When 任务结束时间到达但仍未能启动时，the system shall 将任务标记为 SKIPPED（跳过），并调度下一次执行（重复任务）或标记完成（一次性任务）

### FR-3: 执行日志记录

**用户故事：** 作为用户，我希望能够查看任务被拒绝启动的原因，以便了解任务执行情况。

**验收标准：**

1. When 任务因并发限制被拒绝时，the system shall 在执行日志中记录"因并发播放数已达上限(10)，任务等待中"
2. When 任务重试成功启动时，the system shall 在执行日志中记录"等待空位后成功启动"
3. When 任务因等待超时被跳过时，the system shall 在执行日志中记录"因并发限制等待超时，本次执行被跳过"

### FR-4: SKIPPED 状态 UI 显示

**用户故事：** 作为用户，我希望能够在界面上看到任务被跳过的状态，以便了解任务未能执行的情况。

**验收标准：**

1. When 任务状态为 SKIPPED 时，the system shall 在任务列表中显示"已跳过"状态标签
2. When 用户查看 SKIPPED 状态任务详情时，the system shall 显示跳过原因（如"并发限制"）
3. When 重复任务被跳过后，the system shall 在下一次调度时间正常显示"已调度"状态

## 非功能需求

### NFR-1: 性能要求

- 并发计数检查响应时间 < 10ms
- 不影响现有播放任务的性能

### NFR-2: 可靠性要求

- 并发计数必须准确，不能出现超过10个任务同时播放的情况
- 服务重启后能正确恢复并发计数

### NFR-3: 可配置性

- 最大并发数 10 定义为常量，便于未来调整

## 边界条件和异常处理

| 场景 | 处理方式 |
|-----|---------|
| 服务重启时有任务正在播放 | 重建 taskPlayers 映射，计数从实际播放数开始 |
| 任务异常结束未正常释放 | 依赖现有的 TaskPlayer 清理机制，计数自动更新 |
| 多个任务同时触发启动 | 使用同步机制，先到先得，后到者若超限则等待 |
| 重试闹钟与结束闹钟冲突 | 结束闹钟优先，取消重试 |

## 技术约束

- 基于现有 `AudioPlaybackService` 的 `taskPlayers: ConcurrentHashMap<Long, TaskPlayer>` 实现
- 使用 `taskPlayers.size()` 获取当前播放任务数
- 需要与现有的调度策略（Strategy）协调
- 需要在 `TaskExecutionState` 枚举中新增 `SKIPPED` 状态

