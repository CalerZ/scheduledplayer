# 需求文档 - 任务调度时间+重复逻辑重构

## 概述

当前任务调度系统通过不断打补丁的方式处理各种边缘情况，导致逻辑分散、难以维护。本次重构旨在建立一个统一、清晰的调度模型，系统性地处理所有"时间+重复"的组合场景。

## 用户角色

- **普通用户**：创建和管理定时音乐播放任务
- **系统**：自动执行任务调度、播放控制、状态管理

---

## 任务类型矩阵

根据三个维度，任务可分为 8 种组合：

| # | 重复类型 | 时间类型 | 播放模式 | 场景示例 |
|---|---------|---------|---------|---------|
| 1 | 一次性 | 非跨天 | 定时段 | 今天 9:00-12:00 播放一次 |
| 2 | 一次性 | 跨天 | 定时段 | 今晚 22:00 到明天 02:00 播放一次 |
| 3 | 一次性 | - | 全天 | 今天全天播放一次 |
| 4 | 重复 | 非跨天 | 定时段 | 每周一三五 9:00-12:00 |
| 5 | 重复 | 跨天 | 定时段 | 每周五六 22:00-02:00 |
| 6 | 重复 | - | 全天 | 每周一到五全天播放 |
| 7 | 每天 | 非跨天 | 定时段 | 每天 8:00-18:00 |
| 8 | 每天 | 跨天 | 定时段 | 每天 22:00-06:00 |

---

## 功能需求

### FR-1: 任务状态管理

**用户故事：** 作为系统，我需要准确追踪任务的执行状态，以便正确处理各种场景（如设备重启、蓝牙断连）

**验收标准：**

1. When 任务创建时, the system shall 初始化任务状态为"待调度"
2. When 开始闹钟触发时, the system shall 将任务状态更新为"执行中"并记录执行开始时间
3. When 结束闹钟触发时, the system shall 将任务状态更新为"已完成"并记录执行结束时间
4. When 一次性任务完成时, the system shall 将任务状态标记为"已完成"并禁用任务
5. When 重复任务完成本次执行时, the system shall 重置状态为"待调度"并调度下一次执行

### FR-2: 一次性非跨天任务调度

**用户故事：** 作为用户，我想要创建一个在指定日期和时间段内执行一次的任务

**验收标准：**

1. When 任务创建且开始时间未到时, the system shall 设置开始闹钟和结束闹钟
2. When 任务创建且当前时间在时间段内时, the system shall 立即开始播放并设置结束闹钟
3. When 任务创建且时间段已过时, the system shall 不调度任务并提示用户
4. When 开始闹钟触发时, the system shall 开始播放并记录执行状态
5. When 结束闹钟触发时, the system shall 停止播放并禁用任务
6. If 设备在执行期间重启, then the system shall 根据执行状态决定是否恢复播放

### FR-3: 一次性跨天任务调度

**用户故事：** 作为用户，我想要创建一个从今晚持续到明天凌晨的一次性任务

**验收标准：**

1. When 任务创建时, the system shall 识别跨天场景（结束时间 < 开始时间）
2. When 当前在晚间部分（开始时间之后）时, the system shall 立即开始播放，结束闹钟设置为明天
3. When 当前在凌晨部分（结束时间之前）时:
   - If 任务状态为"执行中", then the system shall 恢复播放
   - If 任务状态不是"执行中", then the system shall 不启动播放（避免重复执行）
4. When 结束闹钟触发时, the system shall 停止播放并禁用任务
5. If 设备在凌晨部分重启, then the system shall 检查执行状态决定是否恢复

### FR-4: 一次性全天播放任务调度

**用户故事：** 作为用户，我想要创建一个在指定日期全天播放的任务

**验收标准：**

1. When 任务创建且当天需要执行时, the system shall 立即开始播放
2. When 午夜（00:00:05）到来时, the system shall 检查任务并停止播放
3. When 任务完成时, the system shall 禁用任务
4. If 设备在播放期间重启, then the system shall 恢复播放（如果仍在当天）

### FR-5: 重复非跨天任务调度

**用户故事：** 作为用户，我想要创建一个在指定星期几的固定时间段重复执行的任务

**验收标准：**

1. When 任务创建时, the system shall 计算下一个符合条件的执行日并设置闹钟
2. When 开始闹钟触发时, the system shall 验证"今天"在重复日中后开始播放
3. When 结束闹钟触发时, the system shall 停止播放并调度下一次执行
4. If 设备在执行期间重启, then the system shall 检查当前是否应该播放并恢复
5. While 任务启用, the system shall 持续调度后续执行

### FR-6: 重复跨天任务调度

**用户故事：** 作为用户，我想要创建一个在指定星期几从晚间持续到次日凌晨的重复任务

**验收标准：**

1. When 任务创建时, the system shall 正确计算跨天的开始和结束时间
2. When 当前在晚间部分时, the system shall 检查"今天"是否在重复日中
3. When 当前在凌晨部分时, the system shall 检查"昨天"是否在重复日中
4. When 结束闹钟触发时, the system shall 停止播放并调度下一次（基于下一个重复日）
5. If 设备在凌晨部分重启, then the system shall 检查"昨天"是否在重复日中决定是否恢复

### FR-7: 重复全天播放任务调度

**用户故事：** 作为用户，我想要创建一个在指定星期几全天播放的任务

**验收标准：**

1. When 任务创建且当天在重复日中时, the system shall 立即开始播放
2. When 午夜到来时, the system shall 检查"明天"是否在重复日中:
   - If 是, then the system shall 继续播放
   - If 否, then the system shall 停止播放
3. When 新的一天开始且在重复日中时, the system shall 开始播放
4. If 设备重启, then the system shall 检查当天是否在重复日中决定是否恢复

### FR-8: 设备重启恢复

**用户故事：** 作为用户，我希望设备重启后正在执行的任务能够自动恢复

**验收标准：**

1. When 设备启动完成时, the system shall 重新调度所有启用的任务
2. When 重新调度时, the system shall 读取任务的执行状态
3. If 任务状态为"执行中"且当前时间仍在有效范围内, then the system shall 恢复播放
4. If 任务状态为"执行中"但当前时间已超出范围, then the system shall 标记任务完成
5. When 所有任务处理完成后, the system shall 设置后续闹钟

### FR-9: 定期状态检查（备份机制）

**用户故事：** 作为系统，我需要定期检查任务状态，以应对闹钟被系统杀死的情况

**验收标准：**

1. While 应用运行, the system shall 每15分钟执行一次状态检查
2. When 检查时发现任务应该播放但未播放, the system shall 启动播放
3. When 检查时发现任务不应该播放但正在播放, the system shall 停止播放
4. When 检查完成后, the system shall 重新调度所有闹钟（修复被取消的闹钟）

---

## 非功能需求

### NFR-1: 可靠性

- 闹钟必须使用 `setAlarmClock`（开始）和 `setExactAndAllowWhileIdle`（结束）确保触发
- 必须在 Doze 模式、省电模式下正常工作
- 支持华为、小米等厂商的严格后台限制

### NFR-2: 一致性

- 任务状态必须与实际播放状态一致
- 执行状态必须持久化存储（数据库）
- 设备重启后状态不丢失

### NFR-3: 可维护性

- 调度逻辑集中在统一的模块中
- 使用清晰的状态机模型
- 每种任务类型的处理逻辑可独立测试

### NFR-4: 时间精度

- 开始时间误差不超过 1 分钟
- 结束时间误差不超过 1 分钟

---

## 边界条件和异常处理

| 场景 | 处理方式 |
|------|---------|
| 用户在任务执行中禁用任务 | 立即停止播放，取消闹钟 |
| 用户修改正在执行的任务时间 | 停止当前播放，重新按新时间调度 |
| 开始时间和结束时间相同 | 视为非跨天任务，实际播放时长为0（或提示用户） |
| 蓝牙设备断开 | 暂停播放，记录状态，蓝牙重连后根据时间判断是否恢复 |
| 音频文件不存在/损坏 | 记录错误日志，跳过该文件继续播放下一个 |
| 午夜边界（23:59:59 到 00:00:00） | 使用 00:00:05 作为午夜检查点避免边界问题 |

---

## 术语定义

| 术语 | 定义 |
|------|------|
| 一次性任务 | `repeatDays = 0`，只执行一次 |
| 重复任务 | `repeatDays != 0`，按指定星期几重复执行 |
| 每天任务 | `repeatDays = 127 (EVERYDAY)`，每天执行 |
| 跨天任务 | `endTime < startTime`，如 22:00-02:00 |
| 全天播放 | `allDayPlay = true`，从午夜到午夜持续播放 |
| 执行状态 | 任务当前的执行阶段：待调度/执行中/已完成 |
| 执行周期 | 任务从开始到结束的一次完整执行 |

