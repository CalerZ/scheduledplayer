# 需求文档 - 定时音频播放任务管理

## 概述

开发一个 Android 应用，允许用户创建定时播放任务，在指定时间范围内自动播放选定的音频文件。支持后台运行和熄屏播放，适用于需要定时播放音频的场景（如噪音反制）。

## 用户角色

- **普通用户**：创建、管理播放任务，选择音频文件，设置播放时间和模式

## 功能需求

### FR-1: 任务创建

**用户故事：** 作为普通用户，我想要创建一个定时播放任务，以便在指定时间自动播放音频

**验收标准：**
1. When 用户点击"新建任务"按钮, the system shall 显示任务创建界面
2. When 用户设置时间范围, the system shall 允许选择开始时间和结束时间（精确到分钟）
3. When 用户点击"选择音频", the system shall 打开系统文件选择器，允许选择多个音频文件
4. When 用户选择播放模式, the system shall 提供"随机播放"和"顺序播放"两个选项
5. When 用户设置重复规则, the system shall 提供以下选项：
   - 一次性（仅执行一次）
   - 每天重复
   - 指定星期几重复（可多选周一至周日）
6. When 用户点击"保存", the system shall 验证必填项（时间范围、至少一个音频文件）并保存任务
7. If 必填项未填写, then the system shall 显示相应的错误提示

### FR-2: 任务管理

**用户故事：** 作为普通用户，我想要管理已创建的任务，以便查看、修改或删除任务

**验收标准：**
1. When 用户打开应用, the system shall 显示所有任务列表
2. When 用户点击某个任务, the system shall 进入任务编辑界面
3. When 用户长按或滑动任务, the system shall 显示删除选项
4. When 用户确认删除, the system shall 删除任务并取消相关的定时器
5. When 用户切换任务的启用/禁用开关, the system shall 更新任务状态并相应地启用或取消定时器

### FR-3: 定时播放

**用户故事：** 作为普通用户，我想要任务在设定时间自动执行，以便无需手动操作

**验收标准：**
1. When 到达任务的开始时间, the system shall 自动开始播放该任务的音频文件
2. When 到达任务的结束时间, the system shall 自动停止播放该任务的音频
3. While 播放模式为"顺序播放", the system shall 按选择顺序依次播放音频，播完后循环
4. While 播放模式为"随机播放", the system shall 随机选择音频播放，播完一首随机选下一首
5. When 多个任务时间重叠, the system shall 同时播放所有任务的音频（混音效果）
6. When 任务为重复任务, the system shall 在每个符合条件的日期自动执行

### FR-4: 后台与熄屏播放

**用户故事：** 作为普通用户，我想要应用在后台和熄屏时也能正常播放，以便不影响手机其他使用

**验收标准：**
1. When 用户将应用切换到后台, the system shall 继续执行定时任务和音频播放
2. When 手机熄屏, the system shall 继续执行定时任务和音频播放
3. While 有启用的任务存在, the system shall 显示前台服务通知，表明应用正在运行
4. When 用户点击前台服务通知, the system shall 打开应用主界面

### FR-5: 音频文件管理

**用户故事：** 作为普通用户，我想要方便地选择和管理音频文件，以便灵活配置任务

**验收标准：**
1. When 用户选择音频文件, the system shall 支持常见音频格式（MP3、WAV、OGG、M4A、FLAC）
2. When 音频文件被删除或移动, the system shall 在播放时跳过不存在的文件并继续播放下一首
3. When 任务中所有音频文件都不存在, the system shall 显示通知提醒用户

### FR-6: 任务执行日志

**用户故事：** 作为普通用户，我想要查看任务的执行历史记录，以便了解任务是否正常运行

**验收标准：**
1. When 任务开始执行, the system shall 记录一条日志，包含：
   - 任务 ID
   - 启动时间
   - 播放状态（进行中）
2. When 任务执行结束, the system shall 更新日志记录，包含：
   - 结束时间
   - 播放结果（成功/失败）
   - 播放的音频文件列表
   - 失败原因（如有）
3. When 任务执行失败, the system shall 记录具体失败原因：
   - 文件缺失
   - 权限问题
   - 播放器错误
   - 其他异常
4. When 用户在任务详情页点击"查看日志", the system shall 显示该任务的执行日志列表
5. When 日志列表显示时, the system shall 按时间倒序排列（最新的在前）
6. While 日志记录超过 30 天, the system shall 自动清理过期日志
7. When 用户查看日志详情, the system shall 显示完整的执行信息（启动时间、结束时间、播放文件、执行结果、失败原因）

## 非功能需求

### NFR-1: 性能要求

- 应用启动时间：冷启动不超过 3 秒
- 定时精度：播放开始/结束时间误差不超过 1 分钟
- 内存占用：后台运行时内存占用不超过 100MB

### NFR-2: 兼容性要求

- 支持 Android 8.0 (API 26) 及以上版本
- 适配不同屏幕尺寸（手机）

### NFR-3: 可靠性要求

- 应用崩溃后重启，应自动恢复所有任务的定时器
- 手机重启后，应自动恢复所有任务的定时器

### NFR-4: 用户体验要求

- 界面简洁直观，主要操作不超过 3 步
- 提供任务状态的视觉反馈（启用/禁用、正在播放等）

## 边界条件和异常处理

| 场景 | 处理方式 |
|------|----------|
| 开始时间晚于结束时间 | 视为跨天任务（如 23:00 - 06:00 表示当晚到次日早晨） |
| 用户未授予存储权限 | 显示权限说明并引导用户授权 |
| 用户未授予通知权限 | 显示权限说明，但不阻止核心功能使用 |
| 选择的音频文件无法播放 | 跳过该文件，播放下一首，记录错误日志 |
| 电池优化限制后台运行 | 引导用户关闭电池优化 |
| 设备处于勿扰模式 | 正常播放音频（需要用户手动管理勿扰设置） |

---

**文档版本：** 1.1  
**创建日期：** 2024-12-24  
**更新日期：** 2024-12-24  
**状态：** 待确认

**更新记录：**
- v1.1: 新增 FR-6 任务执行日志功能
